<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="assets/index.css">
    <link rel="icon" type="image/x-icon" href="https://play-lh.googleusercontent.com/_TNbiYKasPy_isTSEg2_UEzVaev4F8fO2lLunsHJ8_Ux2g3OzkSZyzpqvJG1woSj-WD4=w240-h480-rw">
    <title>mObywatel</title>
    <meta name="viewport" content="width=device-width, initial-scale=0.8, user-scalable=no">
</head>
<body>

    <div class="guide_holder">
        <div class="top_holder">
            <p class="guide_title">Instrukcja</p>
            <img class="arrow" src="images/1GUMnTn.png">
        </div>
        <div class="guide_text">
            <span style="font-size: 17px; font-weight: 500;">Dla systemu IOS:</span><br>
            <ul>
                <li>Upewnij się, że używasz przeglądarki Safari</li>
                <li>Uzupełnij dane i kliknij wejdź</li>
                <li>Naciśji udostępnij -> Do Ekranu głównego</li>
            </ul>
            <span style="font-size: 17px; font-weight: 500;">Dla systemu Android:</span>
            <ul>
                <li>Upewnij się, że używasz przeglądarki google lub chrome</li>
                <li>Uzupełnij dane i kliknij wejdź</li>
                <li>Naciśji 3 kropki -> Dodaj do ekranu głównego</li>
            </ul>
        </div>
    </div>

    <div class="upload" id="uploadArea" style="position:relative;">
        <p class="error" id="uploadError" style="display:none;">To pole jest wymagane</p>

        <!-- preview image element -->
        <img id="uploadPreview" class="upload_uploaded" style="display:none; max-width:180px; max-height:180px; object-fit:cover; border-radius:6px; margin: 18px auto; display:block;" alt="preview">

        <!-- uploading spinner (kept for CSS animation) -->
        <div id="uploadSpinner" class="upload_uploading" style="display:none; width:48px; height:48px; margin: 18px auto;"></div>

        <div class="upload_grid" id="uploadGrid" style="cursor:pointer;">
            <p class="upload_text" id="uploadText">Dodaj zdjęcie</p>
        </div>

        <!-- hidden file input for manual upload -->
        <input type="file" id="fileInput" accept="image/*" style="display:none" capture="environment">
    </div>

    <div class="input_holder">
        <input type="text" id="name" class="input" placeholder="">
        <span class="placeholder">Imię (imiona)</span>
        <p class="error">To pole jest wymagane</p>
    </div>
 
    <div class="input_holder">
        <input type="text" id="surname" class="input" placeholder="">
        <span class="placeholder">Nazwisko</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <p class="top_info">Płeć</p>
    <div class="selector_box">
        <div class="selected_grid">
            <p class="selector_text selected_text">Mężczyzna</p>
            <img class="selected_arrow" src="images/1GUMnTn.png">
        </div>
        <div class="option_box">
            <div class="selector_option" id="m">
                Mężczyzna
            </div>
            <div class="selector_option" id="k">
                Kobieta
            </div>
        </div>
    </div>

    <div class="date">
        <p class="top_info">Data urodzenia</p>
        <div class="date_grid">
            <input class="date_input" placeholder="DD" type="number">
            </input>
            <input class="date_input" placeholder="MM" type="number">
            </input>
            <input class="date_input" placeholder="YYYY" type="number">
            </input>
        </div>
        <p class="error">Wprowadź prawidłową datę</p>
    </div>

    <div class="input_holder">
        <input type="text" id="nationality" class="input" placeholder="">
        <span class="placeholder">Obywatelstwo</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="familyName" class="input" placeholder="">
        <span class="placeholder">Nazwisko rodowe</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="fathersFamilyName" class="input" placeholder="">
        <span class="placeholder">Nazwisko rodowe ojca</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="mothersFamilyName" class="input" placeholder="">
        <span class="placeholder">Nazwisko rodowe matki</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="motherName" class="input" placeholder="">
        <span class="placeholder">Imię matki</span>
        <p class="error">To pole jest wymagane</p>
    </div>
    
    <div class="input_holder">
        <input type="text" id="fatherName" class="input" placeholder="">
        <span class="placeholder">Imię ojca</span>
        <p class="error">To pole jest wymagane</p>
    </div>
    
    <p class="subtext">Miejsce zamieszkania</p>

    <div class="input_holder">
        <input type="text" id="birthPlace" class="input" placeholder="">
        <span class="placeholder">Miejsce urodzenia</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="countryOfBirth" class="input" placeholder="">
        <span class="placeholder">Kraj urodzenia</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="adress1" class="input" placeholder="">
        <span class="placeholder">Ulica i numer domu</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="adress2" class="input" placeholder="">
        <span class="placeholder">Kod pocztowy</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="city" class="input" placeholder="">
        <span class="placeholder">Miasto</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="seria_numer" class="input" placeholder="">
        <span class="placeholder">Seria i numer dowodu:</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="wydany" class="input" placeholder="">
        <span class="placeholder">Data wydania dokumentu</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="waznosc" class="input" placeholder="">
        <span class="placeholder">Data ważności dokumentu</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div style="text-align: center; margin-top: 20px;">
        <button id="generate-dates-btn" style="
          padding: 10px 20px;
          background-color: #1976d2;
          color: white;
          font-size: 16px;
          border: none;
          border-radius: 10px;
          cursor: pointer;
        ">
          Generuj daty
        </button>
    </div>

    <a class="go">wejdź</a>

    <script src="assets/index.js"></script>
    <script src="assets/manifest.js"></script>

    <script>
    // ----- existing helpers kept & minor improvements -----
    function generateDocumentNumber() {
      const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      const series = Array.from({ length: 3 }, () =>
        letters[Math.floor(Math.random() * letters.length)]
      ).join("");

      const number = Math.floor(100000 + Math.random() * 900000); // 6-cyfrowy numer
      return `${series} ${number}`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const input = document.getElementById("seria_numer");
      if (input && !input.value) {
        input.value = generateDocumentNumber();
      }
    });

    function getRandomDateWithinLastYears(years = 2) {
        const now = new Date();
        const past = new Date();
        past.setFullYear(now.getFullYear() - years);
        return new Date(past.getTime() + Math.random() * (now.getTime() - past.getTime()));
    }

    function formatDate(date) {
        const dd = String(date.getDate()).padStart(2, '0');
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const yyyy = date.getFullYear();
        return `${dd}.${mm}.${yyyy}`;
    }

    function calculateDates() {
        const day = parseInt(document.querySelectorAll('.date_input')[0].value);
        const month = parseInt(document.querySelectorAll('.date_input')[1].value);
        const year = parseInt(document.querySelectorAll('.date_input')[2].value);

        const birthDate = new Date(year, month - 1, day);
        const today = new Date();
        const age = today.getFullYear() - birthDate.getFullYear() -
                   (today.getMonth() < birthDate.getMonth() ||
                   (today.getMonth() === birthDate.getMonth() && today.getDate() < birthDate.getDate()) ? 1 : 0);

        if (isNaN(age) || age < 18) {
            return;
        }

        const wydany = getRandomDateWithinLastYears(2);
        const waznosc = new Date(wydany);
        waznosc.setFullYear(wydany.getFullYear() + 5);

        document.getElementById("wydany").value = formatDate(wydany);
        document.getElementById("waznosc").value = formatDate(waznosc);
    }

    document.addEventListener("DOMContentLoaded", () => {
        calculateDates(); // Automatyczne uzupełnienie po załadowaniu (jeśli pola daty urodzenia są wypełnione)
    });

    document.getElementById("generate-dates-btn").addEventListener("click", () => {
        calculateDates();
    });

    // ----- NEW: upload handling & URL param parsing -----
    (function() {
        const uploadArea = document.getElementById('uploadArea');
        const uploadGrid = document.getElementById('uploadGrid');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('uploadPreview');
        const spinner = document.getElementById('uploadSpinner');
        const uploadText = document.getElementById('uploadText');
        const uploadError = document.getElementById('uploadError');

        // helper to show/hide spinner & preview
        function showSpinner() {
            spinner.style.display = 'block';
            preview.style.display = 'none';
            uploadText.style.display = 'none';
            uploadError.style.display = 'none';
        }
        function showPreviewImage(src) {
            spinner.style.display = 'none';
            uploadText.style.display = 'none';
            uploadError.style.display = 'none';
            preview.src = src;
            preview.style.display = 'block';
        }
        function showAddText() {
            spinner.style.display = 'none';
            preview.style.display = 'none';
            uploadText.style.display = 'block';
        }

        // clicking the upload area triggers file selector
        uploadGrid.addEventListener('click', () => {
            fileInput.click();
        });

        // when user selects a file preview it
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            // if file is an image show spinner then preview
            showSpinner();
            const reader = new FileReader();
            reader.onload = function(ev) {
                showPreviewImage(ev.target.result);
            };
            reader.onerror = function() {
                uploadError.textContent = 'Błąd podczas wczytywania zdjęcia';
                uploadError.style.display = 'block';
                showAddText();
            };
            reader.readAsDataURL(file);
        });

        // parse query string and fill fields (also handle image param)
        function getQueryParams() {
            const q = {};
            const query = location.search ? location.search.substring(1) : '';
            if (!query) return q;
            query.split('&').forEach(pair => {
                const [rawKey, rawVal] = pair.split('=');
                if (!rawKey) return;
                const key = decodeURIComponent(rawKey);
                const val = rawVal !== undefined ? decodeURIComponent(rawVal.replace(/\+/g, ' ')) : '';
                q[key] = val;
            });
            return q;
        }

        function tryLoadImageFromUrl(url) {
            if (!url) return;
            // show spinner while loading
            showSpinner();
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
                // If image loads successfully, set preview src to the original URL
                showPreviewImage(url);
            };
            img.onerror = () => {
                // failed to load, revert to add text and show error
                uploadError.textContent = 'Nie można załadować obrazka z podanego adresu';
                uploadError.style.display = 'block';
                showAddText();
            };
            img.src = url;
        }

        function setIfExists(id, value) {
            if (!value) return;
            const el = document.getElementById(id);
            if (el) el.value = value;
        }

        function setSelectorSex(val) {
            const selectedTextEl = document.querySelector('.selected_text');
            if (!selectedTextEl) return;
            if (!val) return;
            // accept 'm', 'male', 'man', 'M', 'Mężczyzna', 'k', 'female' etc
            const lower = val.toString().toLowerCase();
            if (lower === 'm' || lower.includes('male') || lower.includes('mężczy')) {
                selectedTextEl.textContent = 'Mężczyzna';
            } else if (lower === 'k' || lower.includes('f') || lower.includes('kobiet')) {
                selectedTextEl.textContent = 'Kobieta';
            } else {
                // fallback: if value is a full word, try to use it directly
                selectedTextEl.textContent = val;
            }
        }

        function tryParseBirthdayAndFill(birthdayStr) {
            if (!birthdayStr) return;
            // try common formats: DD.MM.YYYY or YYYY-MM-DD or DD/MM/YYYY or D.M.Y
            let day, month, year;
            if (birthdayStr.includes('.')) {
                const parts = birthdayStr.split('.');
                if (parts.length >= 3) {
                    day = parts[0];
                    month = parts[1];
                    year = parts[2];
                }
            } else if (birthdayStr.includes('-')) {
                const parts = birthdayStr.split('-');
                if (parts.length >= 3) {
                    year = parts[0];
                    month = parts[1];
                    day = parts[2];
                }
            } else if (birthdayStr.includes('/')) {
                const parts = birthdayStr.split('/');
                if (parts.length >= 3) {
                    day = parts[0];
                    month = parts[1];
                    year = parts[2];
                }
            } else {
                // fallback: try to detect continuous numeric with length (e.g., DDMMYYYY)
                const digits = birthdayStr.replace(/\D/g, '');
                if (digits.length === 8) {
                    day = digits.substring(0,2);
                    month = digits.substring(2,4);
                    year = digits.substring(4,8);
                }
            }

            const inputs = document.querySelectorAll('.date_input');
            if (inputs && inputs.length >= 3) {
                if (day) inputs[0].value = day;
                if (month) inputs[1].value = month;
                if (year) inputs[2].value = year;
            }
        }

        // run on load: parse params, fill inputs, load image if provided
        document.addEventListener('DOMContentLoaded', () => {
            const params = getQueryParams();

            // map of paramName -> elementId
            const map = {
                name: 'name',
                surname: 'surname',
                nationality: 'nationality',
                familyName: 'familyName',
                fathersFamilyName: 'fathersFamilyName',
                mothersFamilyName: 'mothersFamilyName',
                motherName: 'motherName',
                fatherName: 'fatherName',
                birthPlace: 'birthPlace',
                countryOfBirth: 'countryOfBirth',
                adress1: 'adress1',
                adress2: 'adress2',
                city: 'city',
                seria_numer: 'seria_numer',
                wydany: 'wydany',
                waznosc: 'waznosc'
            };

            Object.keys(map).forEach(k => {
                if (params[k]) setIfExists(map[k], params[k]);
            });

            // sex
            if (params.sex) setSelectorSex(params.sex);

            // birthday
            if (params.birthday) {
                tryParseBirthdayAndFill(params.birthday);
            }

            // image
            if (params.image) {
                // decode and try to load
                tryLoadImageFromUrl(params.image);
            } else {
                showAddText();
            }
        });

        // Try to gracefully show initial state if JS loaded later
        // if no image param and no user action show add text
        setTimeout(() => {
            if (preview.style.display !== 'block' && spinner.style.display !== 'block') {
                showAddText();
            }
        }, 600);

    })();
    </script>

</body>